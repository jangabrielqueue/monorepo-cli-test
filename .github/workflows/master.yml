# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on PR
on:
  push:
    branches:
      - main

jobs:
  Build:
    runs-on: ubuntu-latest
    permissions: write-all

    strategy:
      matrix:
        node-version: [16.x]

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - uses: nrwl/nx-set-shas@v3
      - run: npm ci
      - run: npx nx run-many -t build
      - uses: actions/upload-artifact@v2
        with:
          name: dist
          path: dist
          retention-days: 1

  first_job_test:
    needs: Build
    name: Test Job
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v2
        with:
          name: dist
          path: dist
      - name: Check webapp2 file existence
        id: check_build
        uses: andstor/file-existence-action@v2
        with:
          files: "dist/apps/webapp2-test"
      - name: File Exist
        if: steps.check_build.outputs.files_exists == 'true'
        run: echo "file exist"

  second_job_test:
    needs: Build
    name: Second Test Job
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v2
        with:
          name: dist
          path: dist
      - name: Check webapp2 file existence
        id: check_build
        uses: andstor/file-existence-action@v2
        with:
          files: "dist/apps/first-app"
      - name: File Exist
        if: steps.check_build.outputs.files_exists == 'true'
        run: echo "file exist"

      # - name: Check first-app file
      #   id: first-app-exist
      #   uses: andstor/file-existence-action@v1
      #   with: 
      #     files: "dist/apps/first-app"

      # - name: Check webapp2 file
      #   id: webapp2-exist
      #   uses: andstor/file-existence-action@v1
      #   with: 
      #     files: "dist/apps/webapp2-test"

      # - name: Deploy first-app
      #   if: steps.first-app-exist.outputs.files_exists == 'true'
      #   uses: FirebaseExtended/action-hosting-deploy@v0 
      #   with:
      #     repoToken: '${{ secrets.GITHUB_TOKEN }}'
      #     firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_MONOREPO_CLI_TEST }}'
      #     projectId: monorepo-cli-test
      #     channelId: live
      #     target: monorepo-cli-test

      # - name: Deploy webbapp2
      #   if: steps.webapp2-exist.outputs.files_exists == 'true'
      #   uses: FirebaseExtended/action-hosting-deploy@v0 
      #   with:
      #     repoToken: '${{ secrets.GITHUB_TOKEN }}'
      #     firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_MONOREPO_CLI_TEST }}'
      #     projectId: monorepo-cli-test
      #     channelId: live
      #     target: webapp2-test

